
All metadata query.

```sql
--- monitor tasks 
select *  
from table(information_schema.task_history(  
scheduled_time_range_start=>dateadd('hour',-48,current_timestamp()),  
result_limit => 100));

-- 3rd party Python packages

select * from information_schema.packages where language = 'python' and PACKAGE_NAME like 'sql%parse%';

select * from information_schema.packages where package_name = 'snowflake-snowpark-python' order by version desc;

-- Average query execution time by role
Select
    Role_Name,
    Avg(Execution_Time) / 1000 as Average_Execution_Time,
    Count(*) as Query_Count
From Snowflake.Account_Usage.Query_History
Where Start_Time = :daterange
Group By Role_Name
Order By Role_Name, Average_Execution_Time Desc; 


-- Find any queries currently being blocked
Select * 
From Table(Insight.Information_Schema.Query_History())  
Where Execution_Status ilike 'Blocked';
-- Display all transactions
Show Transactions In Account;
-- Cancel a transaction
Select system$abort_transaction(1594638696404);


/*
    The following queries use the Columns view of the Account_Usage schema to generate table column
    information
*/

Select
    Column_Name,                        -- Column name
    Table_Name,                         -- Table name
    Table_Schema,                       -- Table name
    Table_Catalog as Table_Database,    -- Database name
    Ordinal_Position,                   -- Ordinal position of the column
    Column_Default,                     -- Default value of the column
    Is_Nullable,                        -- Does the column allows nulls
    Data_Type,                          -- Data type
    Character_Maximum_Length,           -- Maximum length of characters for string columns
    Numeric_Precision,                  -- Numeric precision of numeric columns
    Numeric_Precision_Radix,            -- Radix of precision of numeric columns. This is generally either 2 or 10.
    Numeric_Scale,                      -- Scale of numeric columns. Number of digits to the right of the decimal place.
    Is_Identity,                        -- Is this an identity column?
    Identity_Generation,                -- Whether an identity column�s value is always generated or only generated by default. Snowflake only supports by default.
    Identity_Cycle,                     -- Whether the value of an identity column allows cycling. Snowflake only supports no cycle
    Comment,                            -- Column comments
    Deleted as Deleted_Timestamp        -- Deleted timestamp
From Snowflake.Account_Usage.Columns;


-- This query uses the Columns view in the Account_Usage namespace to find deleted columns
Select 
    Column_Name,                        -- Column name
    Table_Name,                         -- Table name
    Table_Schema,                       -- Table name
    Table_Catalog as Table_Database,    -- Database name
    Ordinal_Position,                   -- Ordinal position of the column
    Column_Default,                     -- Default value of the column
    Is_Nullable,                        -- Does the column allows nulls
    Data_Type,                          -- Data type
    Character_Maximum_Length,           -- Maximum length of characters for string columns
    Numeric_Precision,                  -- Numeric precision of numeric columns
    Numeric_Precision_Radix,            -- Radix of precision of numeric columns. This is generally either 2 or 10.
    Numeric_Scale,                      -- Scale of numeric columns. Number of digits to the right of the decimal place.
    Is_Identity,                        -- Is this an identity column?
    Identity_Generation,                -- Whether an identity column�s value is always generated or only generated by default. Snowflake only supports by default.
    Identity_Cycle,                     -- Whether the value of an identity column allows cycling. Snowflake only supports no cycle
    Comment,                            -- Column comments
    Date(Deleted) as Deleted_Timestamp  -- DeletFrom Snowflake.Account_Usage.Columns
From Snowflake.Account_Usage.Columns
Where Deleted IS NOT NULL
Order By Table_Database, Table_Schema, Table_Name, Column_Name;


/*
    This view can be used to query Snowflake data loading history for the last 365 days. The view displays load activity for both COPY INTO <table> 
    statements and continuous data loading using Snowpipe. This view is different than the Load_History view in that it avoids the 10,000 row limitation 
    of the Load_History.
*/

Select
    File_Name,                                      -- Name of the source file
    Stage_Location,                                 -- Name of the stage where the source file is located
    Row_Count,                                      -- Number of rows loaded from the source
    Row_Parsed,                                     -- Number of rows parsed from the source file. This could be NULL for an in progress transfer.
    Pipe_Catalog_Name as Pipe_Database_Name,        -- Database name containing the pipe
    Pipe_Schema_Name,                               -- Schema name containing the pipe
    Pipe_Name,                                      -- Name of the pipe
    Pipe_Received_Time,                             -- Date and time when the Insert request for the file loaded through the pipe was received
    Table_Catalog_Name as Target_Database_Name,     -- Target database name
    Table_Schema_Name as Target_Schema_Name,        -- Target schema name
    Table_Name as Target_Table_Name,                -- Target table name
    Last_Load_Time                                  -- UTC Date and time of the load record. For bulk data loads, this is the time when the file started loading. 
                                                    -- For Snowpipe, this is the time when the file finished loading.
    Error_Count,                                    -- Number of error rows in the source file
    Error_Limit,                                    -- The limit that, when reached, the process is aborted
    First_Error_Message,                            -- First error in the source file
    First_Error_Line_Number,                        -- Line number of the first error
    First_Error_Character_Pos,                      -- Position of the first error character
    First_Error_Column_Name,                        -- Column name of the first error
    Status                                          -- This could be Loaded, Load Failed or Partially Loaded
From Snowflake.Account_Usage.Copy_History
Where LEN(Pipe_Name) > 0;



/*
    This view, Data_Transfer_History is used to query the history of data transferred from Snowflake tables into a different cloud storage provider�s network.
    For example, from Snowflake on AWS to Google Cloud Platform and/or a different geographical region. The function returns the history 
    for the entire Snowflake account.
*/    

Select 
    Start_Time,         -- Start time of the transfer
    End_Time,           -- End time of the transfer
    Source_Cloud,       -- Cloud provider where the data transfer originated. This could be AWS, Google Cloud Platform or Microsoft Azure
    Source_Region,      -- Region where the data transfer originated
    Target_Cloud,       -- Cloud provider where the data transfer ended. This could be AWS, Google Cloud Platform or Microsoft Azure
    Target_Region,      -- Region where the data transfer ended
    Bytes_Transferred,  -- Number of bytes transferred during the start and end time
    Transfer_Type       -- The type of transfer, which can be Copy, Replication, External_Function
From Snowflake.Account_Usage.Data_Transfer_History
Where Start_Time = :daterange
Order By Start_Time Desc


/*
    This view displays a row for each database defined in your account.
*/

Select 
    Database_Name,
    Database_Owner,
    Is_Transient,
    Created,
    Last_Altered,
    Deleted,
    Retention_Time  -- For time travel
From Snowflake.Account_Usage.Databases;


-- Queries that required scanning more than 90% of total partitions
Select 
    Query_Text,
    Database_Name,
    Schema_Name,
    User_Name,
    Partitions_Scanned,
    Partitions_Total
From Snowflake.Account_Usage.Query_History
Where 
    Partitions_Scanned >= Partitions_Total And Partitions_Total > 0
Order By Partitions_Total Desc;

-- Repeat Queries
Select
    Query_Text,
    (Sum(Execution_Time) / 60000) as Total_Execution_Time_In_Seconds,
    Count(*) as Execution_Count
From Snowflake.Account_Usage.Query_History
Where Execution_Status = 'SUCCESS' And Start_Time = :daterange
Group By Query_Text
Having Count(*) > 1
Order By Total_Execution_Time_In_Seconds Desc;



-- Determine a login failure rate for each user who has logged into the account
-- The Login_History table function can be used to query login attempts by Snowflake users

Select
    Event_Timestamp,                -- Time of the login
    Event_Id,                       -- Unique Id of the login
    Event_Type,                     -- This will usually always be "LOGIN"
    User_Name,                      -- User attempting the login
    Client_Ip,                      -- IP address of the login attempt
    Reported_Client_Type,           -- Type of client software attempting the login such as JDBC_Driver, ODBC_Driver etc.
    Reported_Client_Version,        -- Version of the client software
    First_Authentication_Factor,    -- Method used to authenticate the user
    Second_Authentication_Factor,   -- The second factor, if using multi factor authentication
    Is_Success,                     -- Indicates the status of the login attempt
    Error_Code,                     -- Error code in the event of an unsuccessful login attempt
    Error_Message                   -- Error message in the event of an unsuccessful login attempt    
From Snowflake.Account_Usage.Login_History;

-- Determine all unique error messages
Select 
    Error_Message, 
    Count(*) as Error_Count
From Snowflake.Account_Usage.Login_History
Where Is_Success ilike 'No'
Group By Error_Message;

-- Determine failure login rate
Select
    User_Name,
    Sum(Iff(Is_Success = 'NO', 1, 0)) as Failed_Count,
    Count(*) as Login_Count,
    Failed_Count / Login_Count as login_failure_rate
From Snowflake.Account_Usage.Login_History
Where
    Event_Timestamp = :daterange
Group By 1
Order By 4 Desc;


-- This query will retrieve all currently running queries that have execeeded a certain amount of time using the Query_History table function
Select 
    Query_Id,
    Query_Text,
    Database_Name,
    Schema_Name,
    Query_Type,
    Session_Id,
    User_Name,
    Role_Name,
    Warehouse_Name,
    Warehouse_Size,
    Warehouse_Type,
    Cluster_Number,
    Query_Tag,
    Execution_Status,
    Error_Code,
    Error_Message,
    Start_Time,
    End_Time,
    DateDiff(Second, Start_Time, Current_Timestamp) as Total_Elasped_Time_In_Seconds,
    Bytes_Scanned,
    Rows_Produced,
    Compilation_Time,
    Execution_Time,
    Transaction_Blocked_Time
From Table(Snowflake.Information_Schema.Query_History())
Where 
    Execution_Status ilike 'RUNNING' And 
    DateDiff(Second, Start_Time, Current_Timestamp) >= 10;


-- #1

Select 
    LH.User_Name,
    LH.Event_Timestamp as Login_Time,
    LH.Event_Id as Event_Id,
    Count(QH.Query_Id) as Query_Count,
    Avg(QH.Execution_Time) as Average_Query_Execution_Time
From Snowflake.Account_Usage.Login_History LH
    Join Snowflake.Account_Usage.Sessions S on LH.Event_Id = S.Login_Event_Id
    Join Snowflake.Account_Usage.Query_History QH on QH.Session_Id = S.Session_Id
Where LH.Event_Timestamp = :daterange    
Group By 1,2,3
Order By 4 Desc;

-- Practice #3
Select 
   User_Name,
   Sum(Iff(Is_Success ilike 'No', 1, 0)) as Failed_Login_Count,
   Count(*) as Total_Logins,
   Sum(Iff(Is_Success ilike 'No', 1, 0)) / NullIf(Count(*), 0) as Login_Failure_Rate
From Snowflake.Account_Usage.Login_History
Where Event_Timestamp >= Date_Trunc(Month, Current_Date)
Group by User_Name
Order by 4 Desc;

-- Practice #4
Select *
From Snowflake.Account_Usage.Columns
Where 
    Data_Type ilike 'Variant'
    And Deleted = :daterange;

-- Practice #5
Select *
From Snowflake.Account_Usage.Warehouse_Load_History
Where Avg_Queued_Load > 0
Order By Start_Time Desc;

-- Practice #6
Select * 
From Snowflake.Account_Usage.Metering_DaiLy_History
Where Service_Type ilike 'Materialized_View' and USAGE_DATE - :daterange

-- Practice #7

Select Sum(Bytes_Transferred) as Total_Bytes_Transferred
From Snowflake.Account_Usage.Data_Transfer_History
Where Source_Cloud <> Target_Cloud


-- The Grants_To_Roles view can be used to query access control privileges that have been granted to a
-- role.
--
-- Complete list of privileges: https://docs.snowflake.com/en/user-guide/security-access-control-privileges.html

Select 
    Created_On,
    Modified_On,
    Privilege,              -- The type of privilege assigned to the role
    Granted_On,             -- The scope (object) of the privilege
    Name as Object_Name,    -- Object name
    Table_Catalog,          -- Database name
    Table_Schema,           -- Schema name
    Granted_To,             -- This will always be 'ROLE' in this view
    Grantee_Name,           -- The name of the role to which the privilege was granted
    Grant_Option,           -- If this is true, the role can grant the privilege to other roles
    Granted_By              -- The name of the role that granted the privilege
From Snowflake.Account_Usage.Grants_To_Roles
Where Deleted_On IS NULL And Created_On = :daterange


/*
    ALL [ PRIVILEGES ] / All / Grants all the privileges for the specified object type.
    APPLY MASKING POLICY / Global / Grants ability to set a Column-level Security masking policy on a table or view column.
    APPLY ROW ACCESS POLICY / Global / Grants ability to add and drop a Row-level Security row access policy on a table or view.
    APPLY TAG / Global / Grants the ability to add or drop a tag on a Snowflake object.
    ATTACH POLICY / Global / Grants ability to activate a network policy by associating it with your account.
    CREATE <object_type> / Global , Database , Schema / Grants ability to create an object of <object_type> (e.g. CREATE TABLE grants the ability to create a table within a                schema).
    CREATE ACCOUNT / Global / Grants ability to create managed accounts; currently applies only to data providers creating reader accounts for sharing data with consumers.
    CREATE SHARE / Global / Grants ability to create shares; applies to data providers for sharing data with other accounts.
    DELETE / Table / Grants ability to execute a DELETE command on the table.
    EXECUTE TASK / Global / Grants ability to run any tasks owned by the role.
    IMPORT SHARE / Global / Grants ability to view shares shared with your account and create databases from the shares; applies to data consumers.
    OVERRIDE SHARE RESTRICTIONS / Global /
        Grants ability to set value for the SHARE_RESTRICTIONS parameter which enables a Business Critical provider account to add a consumer account (with Non-Business Critical         edition) to a share. For more details, see Enabling Sharing from a Business Critical Account to a non-Business Critical Account.
    IMPORTED PRIVILEGES / Database, Data Exchange / Grants ability to enable roles other than the owning role to access a shared database or manage a Snowflake Data Marketplace /         Data Exchange.
    INSERT / Table / Grants ability to execute an INSERT command on the table.
    MANAGE GRANTS / Global / Grants ability to grant or revoke privileges on any object as if the invoking role were the owner of the object.
    MODIFY / Resource Monitor , Warehouse , Data Exchange Listing , Database , Schema / Grants ability to change the settings or properties of an object (e.g. on a virtual               warehouse, provides the ability to change the size of a virtual warehouse).
    MONITOR / User , Resource Monitor , Warehouse , Database , Schema, Task / Grants ability to see details within an object (e.g. queries and usage within a warehouse).
    MONITOR EXECUTION / Global / Grants ability to monitor pipes (Snowpipe) or tasks in the account.
    MONITOR USAGE / Global / Grants ability to monitor account-level usage and historical information for databases and warehouses; for more details, see Enabling Non-Account             Administrators to Monitor Usage and Billing History in the Classic Web Interface. Additionally grants ability to view managed accounts using SHOW MANAGED ACCOUNTS.
    OPERATE / Warehouse , Task / Grants ability to start, stop, suspend, or resume a virtual warehouse. Grants ability to suspend or resume a task.
    OWNERSHIP / All / Grants ability to delete, alter, and grant or revoke access to an object. Required to rename an object. OWNERSHIP is a special privilege on an object that            is automatically granted to the role that created the object, but can also be transferred using the GRANT OWNERSHIP command to a different role by the owning role (or            any role with the MANAGE GRANTS privilege).
    REFERENCES / Table , External table, View / Grants ability to view the structure of an object (but not the data). For tables, the privilege also grants the ability to                  reference the object as the unique/primary key table for a foreign key constraint.
    SELECT / Table , External table, View, Stream / Grants ability to execute a SELECT statement on the table/view.
    TRUNCATE / Table / Grants ability to execute a TRUNCATE TABLE command on the table.
    UPDATE / Table / Grants ability to execute an UPDATE command on the table.
    USAGE / Warehouse , Data Exchange Listing , Database , Schema / Allows usage of the object
*/

Select
    Grantor,            -- Role which granted the privilege
    Grantee,            -- Role to whom the privilege was granted
    Object_Catalog,     -- Database containing the object on which the privilege is granted
    Object_Schema,      -- Database containing the object on which the privilege is granted
    Object_Name,        -- Name of the object on which the privilege is granted
    Object_Type,        -- Type of the object on which the privilege is granted
    Privilege_Type,     -- Type of the granted privilege
    Is_Grantable,       -- Determines if the privilege was granted using the WITH GRANT OPTION
    Created             -- Creation time
From Information_Schema.Object_Privileges;



-- This query generates total number of queries per month
Select 
    CONCAT(CAST(Date_Part(Year, Start_Time) as String), '-', LPAD(CAST(Date_Part(MONTH, Start_Time) as String),2,'0')) as Period,
    Count(*) as Number_Of_Queries
From Snowflake.Account_Usage.Query_History
Where Start_Time = :daterange
Group By Date_Part(Year, Start_Time), Date_Part(MONTH, Start_Time)
Order By Period;

-- This query generates total number of queries per week
Select 
    CONCAT(CAST(Date_Part(Year, Start_Time) as String), '-', LPAD(CAST(Date_Part(WEEK, Start_Time) as String),2,'0')) as Period,
    Count(*) as Number_Of_Queries
From Snowflake.Account_Usage.Query_History
Where Start_Time = :daterange
Group By Date_Part(Year, Start_Time), Date_Part(WEEK, Start_Time)
Order By Period;

-- Average query execution time per month
Select 
    CONCAT(CAST(Date_Part(Year, Start_Time) as String), '-', LPAD(CAST(Date_Part(MONTH, Start_Time) as String),2,'0')) as Period,
    Count(*) as Query_Count,
    AVG(Execution_Time) / 60000 as Average_Execution_Time_Seconds,
    SUM(Execution_Time) / 60000 as Sum_Execution_Time_Seconds
From Snowflake.Account_Usage.Query_History
Where Start_Time = :daterange
Group By Date_Part(Year, Start_Time), Date_Part(MONTH, Start_Time)
Order By Period;

-- Calculate number of unique users issuing queries for a time period
Select 
    CONCAT(CAST(Date_Part(Year, Start_Time) as String), '-', LPAD(CAST(Date_Part(MONTH, Start_Time) as String),2,'0')) as Period,
    Count(Distinct(User_Name)) as Unique_Users
From Snowflake.Account_Usage.Query_History
Where Start_Time = :daterange
Group By Date_Part(Year, Start_Time), Date_Part(MONTH, Start_Time)
Order By Period;

-- Generate a list of active Roles
Select
    Created_On,
    Name as Role_Name,
    Comment
From Snowflake.Account_Usage.Roles
Where DELETED_ON IS NULL

-- Generate a list of deleted Roles
Select
    Created_On,
    Deleted_On,
    Name as Role_Name,
    Comment
From Snowflake.Account_Usage.Roles
Where DELETED_ON IS NOT NULL


-- Use a Common Table Expression to generate a list of all privileges granted to roles and then all roles granted
-- to users.
-- We have dealt with the Grants_To_Roles view already
With All_Roles_And_Privileges AS
(
  Select 
    Created_On,                 -- When was the role + privilege created?
    Modified_On,                -- When was the role + privilege last modifed?
    Privilege,                  -- What is the privilege?
    Granted_On,                 -- What object was the role + privilege granted on?
    Table_Catalog,              -- Associated database name
    Table_Schema,               -- Associated schema name
    Granted_To,                 -- What was the role + privilege granted to
    Grantee_Name as Role_Name,  -- What role was the role + privilege granted to
    Deleted_On                  -- When was this row deleted?
  From Snowflake.Account_Usage.Grants_To_Roles
),

-- Here we are using the Grants_To_Users view. Note that the Snowflake documentation says this view shows
-- all privileges granted to a user. This is not quite right. This displays all roles granted to users.
Roles_Assigned_To_Users AS
(
    Select
        Created_On,                 -- When was the role assigned to the user?
        Deleted_On,                 -- When was this role deleted?
        Role as Role_Name,          -- Role name
        Granted_To,                 -- What was the role assigned to?
        Grantee_Name as User_Name,  -- Name of user the role was assigned to
        Granted_By                  -- Which role granted this?
    From Snowflake.Account_Usage.Grants_To_Users
)

Select t.*, t2.User_Name
From All_Roles_And_Privileges t
    Left Join Roles_Assigned_To_Users t2 On t.Role_Name = t2.Role_Name
Where t.Deleted_On IS NULL And t2.Deleted_On IS NULL;


/*
    The following queries use the Tables view of the Account_Usage schema to generate table information
*/

Select
    Table_Name,                         -- Table name
    Table_Schema,                       -- Table name
    Table_Catalog as Table_Database,    -- Database name
    Table_Owner,                        -- Name of the role (not user) that owns the table
    Table_Type,                         -- The could be base, temporary or a view
    Is_Transient,                       -- Is the table a transient table
    Clustering_Key,                     -- The column(s) or expression(s) that comprise the clustering key
    Row_Count,                          -- Row count
    Bytes,                              -- Byte count of the table
    Retention_Time,                     -- Retention time for time travel
    Created as Created_Timestamp,       -- Created timestamp
    Last_Altered as Modified_Timestamp, -- Last modified timestamp
    Comment,                            -- Column comments
    Deleted as Deleted_Timestamp        -- Deleted timestamp
From Snowflake.Account_Usage.Tables;

-- Find all deleted tables
Select 
    Table_Name,                         -- Table name
    Table_Schema,                       -- Table name
    Table_Catalog as Table_Database,    -- Database name
    Table_Owner,                        -- Name of the role (not user) that owns the table
    Table_Type,                         -- The could be base, temporary or a view
    Is_Transient,                       -- Is the table a transient table
    Clustering_Key,                     -- The column(s) or expression(s) that comprise the clustering key
    Row_Count,                          -- Row count
    Bytes,                              -- Byte count of the table
    Retention_Time,                     -- Retention time for time travel
    Date(Created),                      -- Created timestamp
    Date(Last_Altered),                 -- Last modified timestamp
    Comment,                            -- Column comments
    Date(Deleted) as Deleted_Timestamp  -- Deleted timestamp
From Snowflake.Account_Usage.Tables
Where Deleted IS NOT NULL;

-- Find the total storage in bytes of all tables (maybe)
Select 
    Table_Catalog as Table_Database,    -- Database name
    Sum(Bytes)                          -- As total storage (?)
From Snowflake.Account_Usage.Tables
Where Deleted IS NOT NULL
Group By Table_Catalog;

-- This query uses the Table_Storage_Metrics view to get a more accurate assessment of storage requirements.
Select
    Table_Catalog as Table_Database,
    Table_Schema,
    Table_Name,
    Is_Transient,
    Active_Bytes,               -- Bytes owned by this table that are in the active state for the table
    Time_Travel_Bytes,          -- Bytes owned by this table that are in the Time Travel state for the table.
    Failsafe_Bytes,             -- Bytes owned by this table that are in the Fail-safe state for the table.
    Retained_For_Clone_Bytes,   -- Bytes owned by this table that are retained after deletion because they are referenced by one or more clones of this table.
    Table_Created,
    Table_Dropped
From Snowflake.Account_Usage.Table_Storage_Metrics;

-- Another view you can use which displays average daily data storage. This includes data in internal stages.
Select
    Usage_Date,
    Storage_Bytes,      -- Number of bytes of table storage
    Stage_Bytes,        -- Number of bytes of storage used by filed in all internal stages.
    Failsafe_Bytes
From Snowflake.Account_Usage.Storage_Usage
Order By Usage_Date Desc;


-- Capture the list of users in the account using the Users view in Account_Usage
--
-- Note: The first time Snowsight is accessed in an account, Snowflake creates an internal WORKSHEETS_APP_USER user to support the 
--       web interface. This user is used to cache query results in an internal stage in your account.
Select 
    Name,
    Created_On,
    Deleted_On,
    Login_Name,
    Display_Name,
    First_Name,
    Last_Name,
    Email,
    Comment,
    Disabled,
    Must_Change_Password,   -- Specifies whether the user is forced to change their password on their next login.
    Snowflake_Lock,         -- Specifies whether a temporary lock has been placed on the user�s account.
    Default_Warehouse,      -- Specifies the virtual warehouse that is active by default for the user�s session upon login.
    Default_Namespace,      -- Specifies the namespace, database and schema, that is active by default for the user�s session upon login
    Default_Role,           -- Specifies the role that is active by default for the user�s session upon login.
    Ext_Authn_Duo,          -- If true the user is using MFA. Cannot be set directly.
    Ext_Authn_uid,          -- MFA user Id
    Last_Success_Login,     
    Expires_At,             -- Date and time the account expires
    Locked_Until_Time,      -- Specifies the number of minutes until the temporary lock on the user login is cleared
    Has_Password,           -- Specifies whether a password was created for the user
    Has_Rsa_Public_Key      -- Specifies whether RSA public key used for key pair authentication has been set up for the user
From Snowflake.Account_Usage.Users;

-- List all current (non-deleted) users
Show Users;

-- Describe the user and display what all the columns mean
Describe User RandyMinder;


-- Retrieve users who never logged in
Show Users;

-- Return all users who have not logged in after 60 days of account creation
-- We are using what is called a table literal. These appear in the From clause of a query
-- and return a set of 0 or more rows. 
-- We're also using a function named Result_Scan which returns the result set of a previous command as if the
-- result was a table.This is normally used with Show or Describe commands.
Select * 
From Table(Result_Scan(Last_Query_Id()))
Where "last_success_login" IS NULL
And DateDiff('Day',"created_on",Current_Date) > 60;

-- Retrieve 'stale' users. These would be users who have not logged in within some
-- threshold period of days
Show Users;

Select * 
From Table(Result_Scan(Last_Query_Id()))
Where DateDiff('Day',"last_success_login",Current_Date) > 60;

-- The Warehouse_Metering_History view is used to return the hourly credit usage for on or more warehouses in your account, for a specified date range.

Select 
    Start_Time,                                             -- Beginning of the hour in which the warehouse usage took place
    End_Time,                                               -- End of the hour in which the warehouse usage took place
    Warehouse_Name,                                         -- Warehouse name
    Credits_Used as Credits_Billed,                         -- Credits billed for the hour
    Credits_Used_Compute as Credits_Used,                   -- Credits used for the hour
    Credits_Used_Cloud_Services as Credits_Cloud_Services   -- Cloud service credits consumed for the hour
From Snowflake.Account_Usage.Warehouse_Metering_History
Order By Start_Time;


-- Monthly credits used by warehouse
Select 
    Concat(Cast(Date_Part(Year, Start_Time) as String), '-', LPad(CAST(Date_Part(Month, Start_Time) as String),2,'0')) as Period,
    Warehouse_Name,
    Sum(Credits_Used) as Monthly_Credits_Billed,
    Sum(Credits_Used_Compute) as Monthly_Credits_Used_Compute
From Snowflake.Account_Usage.Warehouse_Metering_History
Where Start_Time = :daterange
Group By 
    Date_Part(Year, Start_Time), 
    Date_Part(Month, Start_Time), 
    Warehouse_Name
Order By 
    Period, 
    Monthly_Credits_Billed Desc;



-- Warehouse credits used compared to average
Select
    Warehouse_Name,
    Date(Start_Time) as Date,
    Sum(Credits_Used) as Current_Credits_Billed,
    Avg(Sum(Credits_Used)) Over (Partition BY Warehouse_Name Order By DATE Rows 7 Preceding) AS Credits_Used_Average,
    (To_Numeric(Sum(Credits_Used)/Credits_Used_Average*100,10,2)-100)::Number AS Variance_To_Average    
From Snowflake.Account_Usage.Warehouse_Metering_History
Where Start_Time = :daterange And Warehouse_Name <> 'CLOUD_SERVICES_ONLY'
Group By
    Date,
    Warehouse_Name
Order By 
    Warehouse_Name,
    Variance_To_Average Desc;


/*
    This query shows a breakdown of the total credits per month by type of credit consumption:

    Warehouses:  Credits used by compute resources
    Pipes:  Credits used by the near real time loading facility, Snowpipe
    View:  Credits used to refresh Materialized Views
    Clustering:  Credits used by the automatic clustering mechanism
    Reader:  Credits used by Reader Accounts which is typically used to share access to data
*/

Select 
    To_Char(Usage_Date,'YYYYMM') As Year_Month, 
    Sum(Decode(Service_Type, 'WAREHOUSE_METERING', Credits_Billed)) as Warehouse_Credits,
    Sum(Decode(Service_Type, 'PIPE', Credits_Billed)) as Pipe_Credits,
    Sum(Decode(Service_Type,'MATERIALIZED_VIEW', Credits_Billed)) as View_Credits,
    Sum(Decode(Service_Type,'AUTO_CLUSTERING', Credits_Billed)) as Clustering_Credits,
    Sum(Decode(Service_Type,'WAREHOUSE_METERING_READER', Credits_Billed)) as Reader_Credits,
    Sum(Credits_Billed) as Total_Billed_Credits
From Snowflake.Account_Usage.Metering_Daily_History
Where Usage_Date = :daterange
Group By To_Char(Usage_Date,'YYYYMM')
Order By 1;

-- View all the columns in the view
Select *
From Snowflake.Account_Usage.Metering_Daily_History;

-- Credit consumption broken down by hour
Select 
    To_Char(Start_Time,'HH24') As Hour,      
    Sum(Credits_Used)
From Snowflake.Account_Usage.Warehouse_Metering_History
Where Start_Time = :daterange
Group By To_Char(Start_Time,'HH24') 
Order By 1;

-- Credits consumed by warehouse
Select 
    Warehouse_Name, 
    Sum(Credits_Used) as Credits_Used
From Snowflake.Account_Usage.Warehouse_Metering_History
Group By Warehouse_Name
Order By 2 desc;

/*
    We will be using the Warehouse_Events_History view for these queries. This view returns the events that have been triggered for the 
    single-cluster and multi-cluster warehouses in your account in the last 365 days.

    Supported events include:
        Creating, dropping, or altering a warehouse, including resizing the warehouse
        Resuming or suspending a warehouse
        Resuming, suspending, or resizing a cluster in a warehouse (single-cluster and multi-cluster warehouses)
        Stopping or starting additional clusters in a warehouse (multi-cluster warehouses only).    
*/

-- List anytime a warehouse cluster spins up or down
Select
    Timestamp,          -- Timestamp of the event
    Warehouse_Name,     -- Warehouse name
    Cluster_Number,     -- Only valid if a specific cluster was involved. If all clusters were involved, nothing is returned.
    Event_Name,         -- The name of the event that caused the cluster change
    Event_Reason,       -- The cause of the event
    Event_State,        -- The state of the event (Started, Completed, Partially_Completed)
    User_Name,          -- The name of the user initiating the event
    Role_Name,          -- Active role at the time of the event
    Query_Id            -- Internal Query Id used to change the cluster.
From Snowflake.Account_Usage.Warehouse_Events_History
Where Event_Name ilike 'SpinUp_Cluster' Or Event_Name ilike 'Spindown Cluster' And Date(Timestamp) = :daterange;

-- List anytime a warehouse multi-cluster spins up or down
Select 
    Timestamp,          -- Timestamp of the event
    Warehouse_Name,     -- Warehouse name
    Cluster_Number,     -- Only valid if a specific cluster was involved. If all clusters were involved, nothing is returned.
    Event_Name,         -- The name of the event that caused the cluster change
    Event_Reason,       -- The cause of the event
    Event_State,        -- The state of the event (Started, Completed, Partially_Completed)
    User_Name,          -- The name of the user initiating the event
    Role_Name,          -- Active role at the time of the event
    Query_Id            -- Internal Query Id used to change the cluster.
From Snowflake.Account_Usage.Warehouse_Events_History
Where Event_Reason ilike 'MultiCluster_Spinup' Or Event_Reason ilike 'MultiCluster_Spindown' And Date(Timestamp) = :daterange;

-- List anytime a warehouse was resized
Select 
    Timestamp,          -- Timestamp of the event
    Warehouse_Name,     -- Warehouse name
    Cluster_Number,     -- Only valid if a specific cluster was involved. If all clusters were involved, nothing is returned.
    Event_Name,         -- The name of the event that caused the cluster change
    Event_Reason,       -- The cause of the event
    Event_State,        -- The state of the event (Started, Completed, Partially_Completed)
    User_Name,          -- The name of the user initiating the event
    Role_Name,          -- Active role at the time of the event
    Query_Id            -- Internal Query Id used to change the cluster.
From Snowflake.Account_Usage.Warehouse_Events_History
Where Event_Reason ilike 'Warehouse_Resize' And Date(Timestamp) = :daterange;

-- List anytime a warehouse was suspended because of a resource monitor
Select 
    Timestamp,          -- Timestamp of the event
    Warehouse_Name,     -- Warehouse name
    Cluster_Number,     -- Only valid if a specific cluster was involved. If all clusters were involved, nothing is returned.
    Event_Name,         -- The name of the event that caused the cluster change
    Event_Reason,       -- The cause of the event
    Event_State,        -- The state of the event (Started, Completed, Partially_Completed)
    User_Name,          -- The name of the user initiating the event
    Role_Name,          -- Active role at the time of the event
    Query_Id            -- Internal Query Id used to change the cluster.
From Snowflake.Account_Usage.Warehouse_Events_History
Where Event_Reason ilike 'Resource_Monitor_Suspend' And Date(Timestamp) = :daterange;

-- List anytime a suspended warehouse was resumed
Select 
    Timestamp,          -- Timestamp of the event
    Warehouse_Name,     -- Warehouse name
    Cluster_Number,     -- Only valid if a specific cluster was involved. If all clusters were involved, nothing is returned.
    Event_Name,         -- The name of the event that caused the cluster change
    Event_Reason,       -- The cause of the event
    Event_State,        -- The state of the event (Started, Completed, Partially_Completed)
    User_Name,          -- The name of the user initiating the event
    Role_Name,          -- Active role at the time of the event
    Query_Id            -- Internal Query Id used to change the cluster.
From Snowflake.Account_Usage.Warehouse_Events_History
Where Event_Reason ilike 'Warehouse_Resume' And Date(Timestamp) = :daterange;


-- The Warehouse_Load_History view can be used to analyze the workload on your warehouses within a specified date range.
-- Note: Load history is shown in 5-minute intervals.

-- Retrieve information about the workload on each warehouse. 
Select 
    Start_Time,
    End_Time,
    Warehouse_Name,
    Avg_Running,        -- Average number of queries executed      
    Avg_Queued_Load,    -- Average number of queries queued because warehouse was overloaded
    Avg_Blocked         -- Average number of queries blcoked by a transaction lock
From Snowflake.Account_Usage.Warehouse_Load_History
Where Start_Time = :daterange
Order By Warehouse_Name, Start_Time Desc;
```